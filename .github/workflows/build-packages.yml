name: Build and Publish Packages

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'  # Triggers on version tags (e.g., v1.2.3)
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Version number (e.g., 1.2.3) - Leave empty to use commit SHA'
        required: false
        default: ''
      publish_to_github:
        description: 'Publish to GitHub Releases'
        type: boolean
        default: true

env:
  APP_NAME: 'DicomGateway'

jobs:
  # ============================================
  # Job 1: Build ZIP Package (Primary Strategy)
  # ============================================
  build-zip:
    name: Build ZIP Package
    runs-on: windows-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      zip_artifact: ${{ steps.package.outputs.filename }}
      python_version: ${{ steps.get_python_version.outputs.python_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract Python version from pyproject.toml
        id: get_python_version
        shell: pwsh
        run: |
          $content = Get-Content pyproject.toml -Raw
          if ($content -match 'requires-python\s*=\s*">=([0-9.]+)') {
            $version = $matches[1]
            Write-Host "Extracted Python version: $version"
            echo "python_version=$version" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "Could not find Python version, using default 3.12"
            echo "python_version=3.12" >> $env:GITHUB_OUTPUT
          }

      - name: Get version from tag, input, or commit
        id: get_version
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch" -and "${{ github.event.inputs.version }}" -ne "") {
            # Use manual input version
            $version = "${{ github.event.inputs.version }}"
          } elseif ("${{ github.ref_type }}" -eq "tag") {
            # Use tag version (strip 'v' prefix)
            $version = "${{ github.ref_name }}" -replace '^v', ''
          } else {
            # Use short commit SHA
            $version = "${{ github.sha }}".Substring(0, 7)
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ steps.get_python_version.outputs.python_version }}

      - name: Install uv
        shell: pwsh
        run: |
          pip install uv
          uv --version

      - name: Create VERSION file
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          Set-Content -Path "VERSION" -Value $version -NoNewline
          Write-Host "Created VERSION file with: $version"

      - name: Build portable virtual environment
        shell: pwsh
        run: |
          Write-Host "Creating portable virtual environment..."
          uv venv .venv --python ${{ steps.get_python_version.outputs.python_version }}

          Write-Host "Installing dependencies from pyproject.toml..."
          .\.venv\Scripts\Activate.ps1
          uv pip install -e .

          Write-Host "Virtual environment created successfully"

      - name: Run tests
        shell: pwsh
        run: |
          .\.venv\Scripts\Activate.ps1

          # Run pytest if tests exist
          if (Test-Path "tests") {
            Write-Host "Running tests..."
            uv pip install pytest pytest-cov
            pytest tests/ -v --cov=src --cov-report=term-missing
          } else {
            Write-Host "No tests directory found, skipping tests"
          }

      - name: Package ZIP archive
        id: package
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $buildDir = "build\${{ env.APP_NAME }}-$version"
          $zipName = "${{ env.APP_NAME }}-$version.zip"

          Write-Host "Creating build directory: $buildDir"
          New-Item -ItemType Directory -Path $buildDir -Force | Out-Null

          # Copy application files
          Write-Host "Copying application files..."
          Copy-Item -Path "src" -Destination "$buildDir\src" -Recurse
          Copy-Item -Path "pyproject.toml" -Destination "$buildDir\" -Force

          # Copy config template
          if (Test-Path "src\config.yaml") {
            Copy-Item -Path "src\config.yaml" -Destination "$buildDir\src\" -Force
          }

          # Copy VERSION file
          Copy-Item -Path "VERSION" -Destination "$buildDir\" -Force

          # Create startup script
          @"
          @echo off
          REM DICOM Gateway Service Startup Script
          REM Auto-generated by CI/CD pipeline

          set SCRIPT_DIR=%~dp0
          cd /d "%SCRIPT_DIR%"

          REM Set persistent database location
          set DATABASE_PATH=C:\Apps\DicomGatewayMock\data\gateway.db

          REM Run the application using virtual environment Python
          "%SCRIPT_DIR%.venv\Scripts\python.exe" -m src

          REM Keep window open on error
          if errorlevel 1 pause
          "@ | Set-Content -Path "$buildDir\start-service.bat"

          Write-Host "Creating ZIP archive..."
          Compress-Archive -Path "$buildDir\*" -DestinationPath $zipName -CompressionLevel Optimal

          $size = [math]::Round((Get-Item $zipName).Length / 1MB, 2)
          Write-Host "Package created: $zipName ($size MB)"

          echo "filename=$zipName" >> $env:GITHUB_OUTPUT

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: zip-package
          path: ${{ steps.package.outputs.filename }}
          retention-days: 90

  # ============================================
  # Job 2: Build MSI Package (Comparison)
  # ============================================
  # COMMENTED OUT - Only building ZIP for now
  # build-msi:
  #   name: Build MSI Package
  #   runs-on: windows-latest
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Extract Python version from pyproject.toml
  #       id: get_python_version
  #       shell: pwsh
  #       run: |
  #         $content = Get-Content pyproject.toml -Raw
  #         if ($content -match 'requires-python\s*=\s*">=([0-9.]+)') {
  #           $version = $matches[1]
  #           Write-Host "Extracted Python version: $version"
  #           echo "python_version=$version" >> $env:GITHUB_OUTPUT
  #         } else {
  #           Write-Host "Could not find Python version, using default 3.12"
  #           echo "python_version=3.12" >> $env:GITHUB_OUTPUT
  #         }

  #     - name: Get version from tag, input, or commit
  #       id: get_version
  #       shell: pwsh
  #       run: |
  #         if ("${{ github.event_name }}" -eq "workflow_dispatch" -and "${{ github.event.inputs.version }}" -ne "") {
  #           # Use manual input version
  #           $version = "${{ github.event.inputs.version }}"
  #         } elseif ("${{ github.ref_type }}" -eq "tag") {
  #           # Use tag version (strip 'v' prefix)
  #           $version = "${{ github.ref_name }}" -replace '^v', ''
  #         } else {
  #           # Use short commit SHA
  #           $version = "${{ github.sha }}".Substring(0, 7)
  #         }
  #         echo "version=$version" >> $env:GITHUB_OUTPUT
  #         echo "Version: $version"
  #
  #     - name: Install WiX Toolset
  #       shell: pwsh
  #       run: |
  #         Write-Host "Downloading WiX Toolset..."
  #         $wixUrl = "https://github.com/wixtoolset/wix3/releases/download/wix3141rtm/wix314-binaries.zip"
  #         $wixZip = "wix-binaries.zip"
  #         $wixDir = "$env:TEMP\wix"
  #
  #         Invoke-WebRequest -Uri $wixUrl -OutFile $wixZip
  #         Expand-Archive -Path $wixZip -DestinationPath $wixDir -Force
  #
  #         # Add to PATH
  #         $env:PATH = "$wixDir;$env:PATH"
  #         echo "$wixDir" >> $env:GITHUB_PATH
  #
  #         # Verify installation
  #         & "$wixDir\candle.exe" -?
  #         Write-Host "WiX Toolset installed successfully"
  #
  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ steps.get_python_version.outputs.python_version }}
  #
  #     - name: Build MSI
  #       shell: pwsh
  #       working-directory: scripts/powershell/msi
  #       run: |
  #         $version = "${{ steps.get_version.outputs.version }}"
  #         Write-Host "Building MSI package version $version..."
  #
  #         .\build.ps1 -Version $version -OutputDir ".\output"
  #
  #     - name: Upload MSI artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: msi-package
  #         path: scripts/powershell/msi/output/*.msi
  #         retention-days: 90

  # ============================================
  # Job 3: Build EXE Package (Comparison)
  # ============================================
  # Job 3: Build EXE Package (Comparison)
  # ============================================
  # COMMENTED OUT - Only building ZIP for now
  # build-exe:
  #   name: Build EXE Package
  #   runs-on: windows-latest
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Extract Python version from pyproject.toml
  #       id: get_python_version
  #       shell: pwsh
  #       run: |
  #         $content = Get-Content pyproject.toml -Raw
  #         if ($content -match 'requires-python\s*=\s*">=([0-9.]+)') {
  #           $version = $matches[1]
  #           Write-Host "Extracted Python version: $version"
  #           echo "python_version=$version" >> $env:GITHUB_OUTPUT
  #         } else {
  #           Write-Host "Could not find Python version, using default 3.12"
  #           echo "python_version=3.12" >> $env:GITHUB_OUTPUT
  #         }
  #
  #     - name: Get version from tag, input, or commit
  #       id: get_version
  #       shell: pwsh
  #       run: |
  #         if ("${{ github.event_name }}" -eq "workflow_dispatch" -and "${{ github.event.inputs.version }}" -ne "") {
  #           # Use manual input version
  #           $version = "${{ github.event.inputs.version }}"
  #         } elseif ("${{ github.ref_type }}" -eq "tag") {
  #           # Use tag version (strip 'v' prefix)
  #           $version = "${{ github.ref_name }}" -replace '^v', ''
  #         } else {
  #           # Use short commit SHA
  #           $version = "${{ github.sha }}".Substring(0, 7)
  #         }
  #         echo "version=$version" >> $env:GITHUB_OUTPUT
  #         echo "Version: $version"
  #
  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ steps.get_python_version.outputs.python_version }}
  #
  #     - name: Install PyInstaller
  #       shell: pwsh
  #       run: |
  #         Write-Host "Installing PyInstaller..."
  #         pip install pyinstaller
  #         pyinstaller --version
  #
  #     - name: Build EXE
  #       shell: pwsh
  #       working-directory: scripts/powershell/exe
  #       run: |
  #         $version = "${{ steps.get_version.outputs.version }}"
  #         Write-Host "Building EXE package version $version..."
  #
  #         .\build.ps1 -Version $version -OutputDir ".\dist"
  #
  #     - name: Upload EXE artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: exe-package
  #         path: scripts/powershell/exe/dist/*.exe
  #         retention-days: 90

  # ============================================
  # Job 4: Create GitHub Release
  # ============================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-zip] # Removed build-msi, build-exe dependencies
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to_github == 'true')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ needs.build-zip.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## DICOM Gateway Release ${{ needs.build-zip.outputs.version }}

            ### ðŸ“¦ Packages Included

            - **ZIP Package**: Blue/Green deployment with directory junctions
            
            _Note: MSI and EXE packages are currently disabled. Only ZIP package is being built._

            ### ðŸš€ Deployment

            **Production Deployment (ZIP - Recommended):**
            ```powershell
            # Download ZIP package
            az connectedmachine run-command create \
              --resource-group "dtos-gateway-rg" \
              --machine-name "hospital-gateway-01" \
              --name "Deploy-${{ needs.build-zip.outputs.version }}" \
              --script-uri "https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/powershell/zip/deploy.ps1" \
              --parameters '[{"name":"version","value":"${{ needs.build-zip.outputs.version }}"}, {"name":"packageUrl","value":"https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ needs.build-zip.outputs.zip_artifact }}"}]'
            ```

            ### ðŸ“Š Performance Metrics

            Based on benchmarking (see TASK-023):
            - **Deployment Time**: ~13 seconds
            - **Rollback Time**: ~8 seconds
            - **Package Size**: ~45 MB

            ### ðŸ”„ Rollback

            If issues occur, rollback is instant:
            ```powershell
            az connectedmachine run-command create \
              --machine-name "hospital-gateway-01" \
              --script-uri "https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/powershell/zip/rollback.ps1"
            ```

            Co-Authored-By: GitHub Actions <noreply@github.com>
          files: |
            artifacts/zip-package/*
            # artifacts/msi-package/*
            # artifacts/exe-package/*

  # ============================================
  # Job 5: Publish to GitHub Packages (Optional)
  # ============================================
  publish-packages:
    name: Publish to GitHub Packages
    runs-on: ubuntu-latest
    needs: [build-zip, build-msi, build-exe]
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to_github == 'true')
    permissions:
      packages: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download ZIP artifact
        uses: actions/download-artifact@v4
        with:
          name: zip-package
          path: packages

      - name: Publish ZIP to GitHub Packages
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.build-zip.outputs.version }}"
          ZIP_FILE="packages/${{ needs.build-zip.outputs.zip_artifact }}"

          echo "Publishing $ZIP_FILE to GitHub Packages..."

          # Upload using GitHub's Package API
          curl -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/zip" \
            --data-binary "@$ZIP_FILE" \
            "https://uploads.github.com/repos/${{ github.repository }}/releases/tags/${{ github.ref_name }}/assets?name=${{ needs.build-zip.outputs.zip_artifact }}"

          echo "Package published successfully"

  # ============================================
  # Job 6: Generate Build Report
  # ============================================
  build-report:
    name: Generate Build Report
    runs-on: ubuntu-latest
    needs: [build-zip, build-msi, build-exe]

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate build report
        shell: bash
        run: |
          echo "# Build Report" > build-report.md
          echo "" >> build-report.md
          echo "**Version:** ${{ needs.build-zip.outputs.version }}" >> build-report.md
          echo "**Build Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> build-report.md
          echo "**Commit:** ${{ github.sha }}" >> build-report.md
          echo "" >> build-report.md
          echo "## Artifacts" >> build-report.md
          echo "" >> build-report.md

          # ZIP Package
          if [ -d "artifacts/zip-package" ]; then
            ZIP_FILE=$(ls artifacts/zip-package/*.zip | head -n 1)
            ZIP_SIZE=$(du -h "$ZIP_FILE" | cut -f1)
            echo "- **ZIP Package**: $ZIP_FILE ($ZIP_SIZE)" >> build-report.md
          fi

          # MSI Package
          if [ -d "artifacts/msi-package" ]; then
            MSI_FILE=$(ls artifacts/msi-package/*.msi | head -n 1)
            MSI_SIZE=$(du -h "$MSI_FILE" | cut -f1)
            echo "- **MSI Package**: $MSI_FILE ($MSI_SIZE)" >> build-report.md
          fi

          # EXE Package
          if [ -d "artifacts/exe-package" ]; then
            EXE_FILE=$(ls artifacts/exe-package/*.exe | head -n 1)
            EXE_SIZE=$(du -h "$EXE_FILE" | cut -f1)
            echo "- **EXE Package**: $EXE_FILE ($EXE_SIZE)" >> build-report.md
          fi

          echo "" >> build-report.md
          echo "## Next Steps" >> build-report.md
          echo "" >> build-report.md
          echo "1. Review the release artifacts" >> build-report.md
          echo "2. Deploy to test environment" >> build-report.md
          echo "3. Run health checks" >> build-report.md
          echo "4. Approve production deployment via Azure DevOps" >> build-report.md

          cat build-report.md

      - name: Upload build report
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: build-report.md
          retention-days: 90
